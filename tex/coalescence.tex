\section{Coalescence}
    
    \begin{definition}[Petri Nets]
        For the purposes required here, a \textit{petri net} $\mathcal{N}$ is $(\mathcal{P, F})$ where $f \in \mathcal{F} : \mathcal{P}^m \times \mathcal{P}$.
        In particular, $\mathcal{P}$ is a set of places and $\mathcal{F}$ a set of flows or transitions.
        A \textit{configuration} is a set $\mathcal{C} \subset \mathcal{P}$ of tokens in places.

        Given a formula in classical logic, conjunction or disjunction is encoded as:
        \begin{align*}
            A_1 \vee_2 B_3    &\quad\mapsto\quad \{ (A_1) \times \vee_2, (B_3) \times \vee_2 \} \\
            A_1 \wedge_2 B_3 &\quad\mapsto\quad \{ (A_1, B_3) \times \wedge_2 \}
        \end{align*}
        where $A, B$ are (not necessarily unique) subformulae in unique places iterated over by $\{1, 2, \ldots\}$.
    \end{definition}

    \begin{example}
        Consider the 2-d petri net representing the cross-product $a \vee \neg a \otimes \neg a \wedge a$ as follows:
        \input{coalescence-example-1}
    \end{example}


    \begin{definition}[Firing Petri Nets]
        Given a petri net $\mathcal{N}$ and configuration $\mathcal{C}$, a \textit{firing} of the net $\mathcal{N}$ is a new configuration generated by application of a transition $f \in \mathcal{F}$ on $m$ tokens $c_1 \ldots c_n \in \mathcal{C}$.
        In particular:
        \begin{equation*}
            (\mathcal{N = (P, F), C}) \mapsto (\mathcal{N}, (\mathcal{C} \cup f_{right}) \setminus f_{left})
        \end{equation*}
        for some $f = (f_{left}, f_{right}) \in \mathcal{F}$
        
        For the uses required here, a variant of firing is used instead called \textit{spawning}.
        This generates new configurations in the same manner as firing, with one key difference:
        \begin{equation*}
            (\mathcal{N = (P, F), C}) \mapsto (\mathcal{N}, \mathcal{C} \cup f_{right})
        \end{equation*}
        for some $f = (f_{left}, f_{right}) \in \mathcal{F}$.
        That is, when a transition $f$ is performed on tokens $x_1 \ldots _n$, these tokens remain present in the configuration in addition to the new token $f(x_1 \ldots x_n)$.
        
        A petri net is said to be \textit{exhaustively fired} if it is fired until there does not exist any such $f \in \mathcal{F}$ to fire.
    \end{definition}

    \begin{example}
        Consider the 2d petri net representing $a \vee \neg a \otimes \neg a \wedge a$ with tokens at $\{(a, \neg a), (\neg a, a)\}$.
        \input{coalescence-example-2}
        Note in the final step the pair of tokens required to perform the conjunction transition.
    \end{example}


    \begin{definition}[Coalescence]
        Given a formula $P$, the coalescence algorithm is as follows:
        \begin{enumerate}[nosep]
            \item Set  $n \seteq 1$
            \item Construct a $n$-dimensional petri net $\mathcal{N}$ as $\bigotimes_n P$ where each subformula represents a place and each conjunction and disjunction a flow
            \item Construct a configuration $C$ with a token at each place $p = (\ldots, a, \ldots, \neg a, \ldots)$ the intersection of a pair of tautological atoms or $(\ldots, \top, \ldots)$ an instance of \textit{top}
            \item Exhaustively fire the petri net $\mathcal{N}$ using the \textit{spawning} method
            \item If there exists a token in the configuration $\mathcal{C^*}$ at the root of the formula $P$, halt and return $n$
            \item Otherwise, increment $n \seteq n + 1$ and go to step 2
        \end{enumerate}
    \end{definition}
    
    \begin{example}
        Consider the petri net proof for the formula $(a \vee b) \vee \neg a$, with a solution for $n = 2$.
        The net is initialised with tokens in all places satisfying either the $ax$-rule or $\top$-rule and fired exhaustively:
        \input{coalescence-example-3}
    \end{example}

    \begin{remark}
        Note the symmetry along the upper-left lower-right diagonal.
        In fact, this symmetry can be exploited in the general case, ignoring all tokens below (w.l.o.g.) the diagonal as they simply express the commutativity property $\vdash A, B \iff \vdash B, A$.
        If this is the case, the coalescence algorithm may halt early if the root of the formula is reached.
    \end{remark}

    \begin{example}
        Consider the petri net proof for the formula $(a \vee \neg a) \wedge (b \vee \neg b)$, with a solution for $n = 3$.
        In an exhaustively fired net for $n = 2$, the proof looks as follows:
        \input{coalescence-example-4}
        The coalescence algorithm fails to find a solution in 2 dimensions due to the lack of tokens in upper-right or lower-left quadrants.
        If there were tokens in such a place, the tree would be able to continue to grow towards the formula root at the centre of the net.
    \end{example}

    \begin{remark}
        Implementing firable petri nets is straightforward using an $n$-dimensional boolean array of places visited and a collection of $n$-tuples representing tokens.
        Within the context of coalescence proof search, this can be optimised in many ways, in this case a upper-triangular n-dimensional boolean matrix of places visited and a red-black tree of n-dimensional boolean array tokens can be used.
        This exploits most of the available symmetry in the structure of the nets as, in implementation, memory quickly becomes the limiting factor.
        Furthermore, this structure allows for $\mathcal{O}(\log{}n)$ insertion and removal, $\mathcal{O}(n)$ iteration and minimal memory.
    \end{remark}


    \begin{proposition}[Coalescence Proof Search]
        The coalescence algorithm on $P$ is exactly a proof search on $P$.
    \end{proposition}

    \begin{proof}
        In particular, consider the additively stratified $\vdash P$ with $n - 1$ contractions (should such a proof exist).
        The first configuration of tokens is precisely a proof all possible combinations of the \textit{axiom} rule with $n - 3$ other terms through the \textit{weakening}.
        Each flow transition followed when fired is an application of either the $\vee$ or $\wedge$ rule.
        Finally, a token at the root of the formula is $\vdash P \ldots P$, with the \textit{contraction} rule applied implicitly.

        If there exists an additively stratified proof of $P$, the coalescence algorithm will find it.
        Since for every proof there exists an additively stratified proof, coalescence is precisely proof search.
    \end{proof}

